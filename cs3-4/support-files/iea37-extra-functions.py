from __future__ import print_function   # For Python 3 compatibility
import numpy as np
import sys
import yaml                             # For reading .yaml files
from math import radians as DegToRad    # For converting degrees to radians
from math import log as ln              # For natural logrithm


def calcWeibull(x, L, k):
    """Given a set of <Lambda>, <k> Weibull variables,
        returns the function evaluation at <x>
    """
    if x < 0:
        return 0
    else:
        fFirstPart = (k/L) * ((x/L)**(k-1))
        fSecondPart = np.exp(-((x/L)**k))
        return fFirstPart * fSecondPart


def calcWeibullInt(x, L, k):
    """Given a set of <Lambda>, <k> Weibull variables,
        returns the integral of the Weibull function at <x>
    """
    if x < 0:
        return 0
    else:
        return 1 - np.exp(-((x/L)**k))
    return


def binWindSpeeds(speed_weib, num_speed_bins, min_speed, max_speed):
    """Given an array of [Lambda, k] Weibull variables in <speed_weib>,
        creates <num_speed_bins> many probabilities and speeds
    """
    bin_divs = np.linspace(min_speed, max_speed, num=(
        num_speed_bins+1))
    num_dir_bins = len(speed_weib)
    # Matrix of proabilities for each speed bin and direcitonal bin
    wind_speeds = np.zeros((num_dir_bins, num_speed_bins))
    wind_speed_probs = np.zeros((num_dir_bins, num_speed_bins))
    #print(bin_divs)
    #print(num_dir_bins)
    # For each bin, find the relevant values
    for i in range(num_dir_bins):
        for j in range(num_speed_bins):
            # The area under the curve is the diff of the integral evaluated
            # at start and end of bin.
            wind_speed_probs[i][j] = \
                calcWeibullInt(bin_divs[j+1], speed_weib[i][0], speed_weib[i][1]) - \
                calcWeibullInt(bin_divs[j], speed_weib[i][0], speed_weib[i][1])
            # Calculations for finding wind speed of 50% frequency in bin
            halfIntegral = wind_speed_probs[i][j]/2
            RHS = halfIntegral + \
                calcWeibullInt(bin_divs[j], speed_weib[i][0], speed_weib[i][1])
            # x = Lambda * (kth root of (-ln(1 - (1/2)Integral)))
            wind_speeds[i][j] = round(speed_weib[i][0] *
                                      ((- ln(1-RHS)) ** (1/speed_weib[i][1])), 2)
        # Normalize to 6 decimal places
        wind_speed_probs[i] = np.around(wind_speed_probs[i], decimals=6)
        wind_speed_probs[i] = wind_speed_probs[i] / sum(wind_speed_probs[i])

    return wind_speeds, wind_speed_probs


if __name__ == "__main__":

    #-- Bin the wind speeds from continuous Weibull --#
    # 60 bins:
    #speed_weib = [  [9.02, 2.10],  [8.85, 2.09],  [8.72, 2.09],  [8.63, 2.09],  [8.55, 2.10],
    #                [8.49, 2.12],  [8.44, 2.15],  [8.41, 2.18],  [8.42, 2.22],  [8.47, 2.26],
    #                [8.57, 2.29],  [8.75, 2.32],  [8.99, 2.35],  [9.27, 2.39],  [9.57, 2.43],
    #                [9.88, 2.48], [10.17, 2.54], [10.44, 2.60], [10.68, 2.65], [10.88, 2.71],
    #               [11.02, 2.75], [11.11, 2.78], [11.16, 2.8],  [11.17, 2.80], [11.18, 2.79],
    #               [11.18, 2.77], [11.18, 2.75], [11.20, 2.72], [11.23, 2.69], [11.25, 2.65], 
    #               [11.28, 2.62], [11.32, 2.57], [11.34, 2.53], [11.36, 2.49], [11.38, 2.44], 
    #               [11.37, 2.40], [11.35, 2.36], [11.31, 2.33], [11.26, 2.30], [11.21, 2.28],
    #               [11.16, 2.26], [11.12, 2.26], [11.10, 2.25], [11.08, 2.26], [11.08, 2.26], 
    #               [11.09, 2.27], [11.11, 2.28], [11.13, 2.29], [11.14, 2.29], [11.13, 2.30], 
    #               [11.09, 2.29], [11.02, 2.29], [10.90, 2.28], [10.74, 2.26], [10.55, 2.23],
    #               [10.32, 2.21], [10.06, 2.18], [ 9.78, 2.15],  [9.50, 2.12],  [9.24, 2.11]]
    # 20 bins:
    # speed_weib = [  [ 9.02, 2.1],   [8.63, 2.09],  [8.44, 2.15],  [8.47, 2.26],  [8.99, 2.35],
    #                 [ 9.88, 2.48], [10.68, 2.65], [11.11, 2.78], [11.18, 2.79], [11.20, 2.72],
    #                 [11.28, 2.62], [11.36, 2.49], [11.35, 2.36], [11.21, 2.28], [11.10, 2.25],
    #                 [11.09, 2.27], [11.14, 2.29], [11.02, 2.29], [10.55, 2.23],  [9.78, 2.15]]
    # 360 bins:
    speed_weib = [   [9.02, 2.10],  [8.99, 2.09],  [8.96, 2.09],  [8.93, 2.09],  [8.90, 2.09],
                     [8.88, 2.09],  [8.85, 2.09],  [8.83, 2.09],  [8.80, 2.09],  [8.78, 2.09],
                     [8.76, 2.09],  [8.74, 2.09],  [8.72, 2.09],  [8.71, 2.09],  [8.69, 2.09],
                     [8.67, 2.09],  [8.66, 2.09],  [8.64, 2.09],  [8.63, 2.09],  [8.61, 2.09],
                     [8.60, 2.10],  [8.59, 2.10],  [8.58, 2.10],  [8.57, 2.10],  [8.55, 2.10],
                     [8.54, 2.11],  [8.53, 2.11],  [8.52, 2.11],  [8.51, 2.12],  [8.50, 2.12],
                     [8.49, 2.12],  [8.49, 2.13],  [8.48, 2.13],  [8.47, 2.14],  [8.46, 2.14],
                     [8.45, 2.15],  [8.44, 2.15],  [8.44, 2.16],  [8.43, 2.16],  [8.43, 2.17],
                     [8.42, 2.17],  [8.42, 2.18],  [8.41, 2.18],  [8.41, 2.19],  [8.41, 2.20],
                     [8.41, 2.20],  [8.41, 2.21],  [8.41, 2.21],  [8.42, 2.22],  [8.42, 2.23],
                     [8.43, 2.23],  [8.44, 2.24],  [8.44, 2.25],  [8.45, 2.25],  [8.47, 2.26],
                     [8.48, 2.26],  [8.50, 2.27],  [8.51, 2.27],  [8.53, 2.28],  [8.55, 2.28],
                     [8.57, 2.29],  [8.60, 2.29],  [8.63, 2.30],  [8.65, 2.30],  [8.69, 2.31],
                     [8.72, 2.31],  [8.75, 2.32],  [8.79, 2.32],  [8.82, 2.33],  [8.86, 2.33],
                     [8.90, 2.34],  [8.94, 2.35],  [8.99, 2.35],  [9.03, 2.36],  [9.08, 2.36],
                     [9.12, 2.37],  [9.17, 2.37],  [9.22, 2.38],  [9.27, 2.39],  [9.31, 2.39],
                     [9.36, 2.40],  [9.42, 2.41],  [9.47, 2.41],  [9.52, 2.42],  [9.57, 2.43],
                     [9.62, 2.44],  [9.67, 2.45],  [9.72, 2.45],  [9.77, 2.46],  [9.83, 2.47],
                     [9.88, 2.48],  [9.93, 2.49],  [9.98, 2.50], [10.03, 2.51], [10.08, 2.52],
                    [10.13, 2.53], [10.17, 2.54], [10.22, 2.55], [10.27, 2.56], [10.31, 2.57],
                    [10.36, 2.58], [10.40, 2.59], [10.44, 2.60], [10.49, 2.61], [10.53, 2.62],
                    [10.57, 2.63], [10.61, 2.64], [10.65, 2.65], [10.68, 2.65], [10.72, 2.66],
                    [10.75, 2.67], [10.78, 2.68], [10.82, 2.69], [10.85, 2.70], [10.88, 2.71],
                    [10.90, 2.72], [10.93, 2.72], [10.95, 2.73], [10.98, 2.74], [11.00, 2.75],
                    [11.02, 2.75], [11.04, 2.76], [11.06, 2.76], [11.07, 2.77], [11.08, 2.77],
                    [11.10, 2.78], [11.11, 2.78], [11.12, 2.78], [11.13, 2.79], [11.14, 2.79],
                    [11.14, 2.79], [11.15, 2.79], [11.16, 2.80], [11.16, 2.80], [11.16, 2.80],
                    [11.17, 2.80], [11.17, 2.80], [11.17, 2.80], [11.17, 2.80], [11.17, 2.80],
                    [11.18, 2.80], [11.18, 2.79], [11.18, 2.79], [11.18, 2.79], [11.18, 2.79],
                    [11.18, 2.79], [11.18, 2.78], [11.18, 2.78], [11.18, 2.78], [11.18, 2.77],
                    [11.18, 2.77], [11.18, 2.77], [11.18, 2.76], [11.18, 2.76], [11.18, 2.76],
                    [11.18, 2.75], [11.18, 2.75], [11.19, 2.74], [11.19, 2.74], [11.19, 2.74],
                    [11.19, 2.73], [11.20, 2.73], [11.20, 2.72], [11.21, 2.72], [11.21, 2.71],
                    [11.21, 2.71], [11.22, 2.70], [11.22, 2.70], [11.23, 2.69], [11.23, 2.68],
                    [11.23, 2.68], [11.24, 2.67], [11.24, 2.67], [11.25, 2.66], [11.25, 2.65],
                    [11.26, 2.65], [11.26, 2.64], [11.27, 2.64], [11.27, 2.63], [11.28, 2.62],
                    [11.28, 2.62], [11.29, 2.61], [11.30, 2.60], [11.30, 2.59], [11.31, 2.59],
                    [11.31, 2.58], [11.32, 2.57], [11.32, 2.57], [11.33, 2.56], [11.33, 2.55],
                    [11.34, 2.54], [11.34, 2.54], [11.34, 2.53], [11.35, 2.52], [11.35, 2.52],
                    [11.36, 2.51], [11.36, 2.50], [11.36, 2.49], [11.36, 2.49], [11.37, 2.48],
                    [11.37, 2.47], [11.37, 2.46], [11.37, 2.46], [11.37, 2.45], [11.38, 2.44],
                    [11.38, 2.44], [11.38, 2.43], [11.37, 2.42], [11.37, 2.41], [11.37, 2.41],
                    [11.37, 2.40], [11.37, 2.39], [11.36, 2.39], [11.36, 2.38], [11.36, 2.37],
                    [11.35, 2.37], [11.35, 2.36], [11.34, 2.36], [11.34, 2.35], [11.33, 2.34],
                    [11.32, 2.34], [11.32, 2.33], [11.31, 2.33], [11.30, 2.32], [11.29, 2.32],
                    [11.28, 2.31], [11.28, 2.31], [11.27, 2.30], [11.26, 2.30], [11.25, 2.30],
                    [11.24, 2.29], [11.23, 2.29], [11.23, 2.28], [11.22, 2.28], [11.21, 2.28],
                    [11.20, 2.28], [11.19, 2.27], [11.19, 2.27], [11.18, 2.27], [11.17, 2.27],
                    [11.16, 2.26], [11.16, 2.26], [11.15, 2.26], [11.14, 2.26], [11.14, 2.26],
                    [11.13, 2.26], [11.12, 2.26], [11.12, 2.26], [11.11, 2.25], [11.11, 2.25],
                    [11.11, 2.25], [11.10, 2.25], [11.10, 2.25], [11.10, 2.26], [11.09, 2.26],
                    [11.09, 2.26], [11.09, 2.26], [11.09, 2.26], [11.08, 2.26], [11.08, 2.26],
                    [11.08, 2.26], [11.08, 2.26], [11.08, 2.26], [11.08, 2.26], [11.08, 2.26],
                    [11.08, 2.27], [11.08, 2.27], [11.08, 2.27], [11.09, 2.27], [11.09, 2.27],
                    [11.09, 2.27], [11.09, 2.27], [11.10, 2.28], [11.10, 2.28], [11.10, 2.28],
                    [11.11, 2.28], [11.11, 2.28], [11.11, 2.28], [11.12, 2.28], [11.12, 2.29],
                    [11.12, 2.29], [11.13, 2.29], [11.13, 2.29], [11.13, 2.29], [11.14, 2.29],
                    [11.14, 2.29], [11.14, 2.29], [11.14, 2.29], [11.14, 2.29], [11.14, 2.29],
                    [11.14, 2.30], [11.14, 2.30], [11.14, 2.30], [11.14, 2.30], [11.13, 2.30],
                    [11.13, 2.30], [11.12, 2.30], [11.12, 2.30], [11.11, 2.30], [11.10, 2.30],
                    [11.09, 2.29], [11.08, 2.29], [11.07, 2.29], [11.06, 2.29], [11.05, 2.29],
                    [11.03, 2.29], [11.02, 2.29], [11.00, 2.29], [10.98, 2.28], [10.96, 2.28],
                    [10.94, 2.28], [10.92, 2.28], [10.90, 2.28], [10.88, 2.27], [10.85, 2.27],
                    [10.83, 2.27], [10.80, 2.26], [10.77, 2.26], [10.74, 2.26], [10.72, 2.25],
                    [10.68, 2.25], [10.65, 2.25], [10.62, 2.24], [10.59, 2.24], [10.55, 2.23],
                    [10.52, 2.23], [10.48, 2.23], [10.44, 2.22], [10.40, 2.22], [10.37, 2.21],
                    [10.32, 2.21], [10.28, 2.20], [10.24, 2.20], [10.20, 2.19], [10.15, 2.19],
                    [10.11, 2.18], [10.06, 2.18], [10.02, 2.17],  [9.97, 2.17],  [9.92, 2.16],
                     [9.88, 2.16],  [9.83, 2.15],  [9.78, 2.15],  [9.74, 2.14],  [9.69, 2.14],
                     [9.64, 2.13],  [9.59, 2.13],  [9.55, 2.13],  [9.50, 2.12],  [9.46, 2.12],
                     [9.41, 2.12],  [9.37, 2.11],  [9.33, 2.11],  [9.28, 2.11],  [9.24, 2.11],
                     [9.20, 2.10],  [9.16, 2.10],  [9.13, 2.10],  [9.09, 2.10],  [9.06, 2.10] ]
    num_speed_bins = 20 #len(speed_weib)
    min_speed = 0.0
    max_speed = 25.0
    wind_speeds, wind_speed_probs = binWindSpeeds(speed_weib, num_speed_bins, min_speed,
                                                  max_speed)
    wind_speed_probs = np.around(wind_speed_probs, decimals=10)
    wind_speed_probs = wind_speed_probs / np.sum(wind_speed_probs, axis=1)
    #print(wind_speed_probs)
    #print(np.sum(wind_speed_probs, axis=1))
    np.savetxt('new-windspeeds.txt', wind_speeds,
               fmt='%.2f', delimiter=', ')
    np.savetxt('new-windspeedprobs.txt', wind_speed_probs,
               fmt='%.10f', delimiter=', ')
